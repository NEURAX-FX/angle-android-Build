name: Build ANGLE for Android (Standalone)

on:
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'

      - name: Setup Depot Tools
        run: |
          git clone --depth 1 https://chromium.googlesource.com/chromium/tools/depot_tools.git
          echo "$PWD/depot_tools" >> $GITHUB_PATH

      - name: Sync ANGLE Standalone (The "Lightweight" Way)
        run: |
          mkdir angle-standalone && cd angle-standalone
          # 关键点：配置 .gclient 只关注 ANGLE 及其 Android 依赖
          gclient config --spec 'solutions = [
            {
              "name": "src",
              "url": "https://chromium.googlesource.com/angle/angle.git",
              "deps_file": "DEPS",
              "managed": False,
              "custom_deps": {},
              "custom_vars": {"checkout_android": True},
            },
          ]
          target_os = ["android"]'
          
          # 使用 --no-history 和 --shallow 极致瘦身
          # 这步只会拉取 ANGLE 必需的 2GB 左右的依赖，而不是 60GB 的 Chromium
          gclient sync --no-history --shallow --nohooks -j$(nproc)

      - name: Run Hooks (Download Toolchains)
        run: |
          cd angle-standalone/src
          # 这一步会下载 Clang 和 Android NDK，大概几百 MB
          gclient runhooks

      - name: Configure Build (GN Args)
        run: |
          cd angle-standalone/src
          # 为天玑 9300 (arm64) 定制，开启 Vulkan，关闭不必要的后端
          gn gen out/Release --args='
            target_os="android"
            target_cpu="arm64"
            is_debug=false
            is_component_build=false
            angle_enable_vulkan=true
            angle_enable_gl=true
            angle_enable_wgpu=false
            symbol_level=0
            android64_ndk_api_level=34
            angle_standalone=true'

      - name: Build System ANGLE APK
        run: |
          cd angle-standalone/src
          # 编译特定的 APK 目标
          autoninja -C out/Release angle_apks

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: System-ANGLE-arm64
          path: angle-standalone/src/out/Release/apks/*.apk
